{% extends "base.html" %}

{% block title %}Investor Dashboard{% endblock %}

{% block content %}
<!-- Clean Header -->
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-1">Investor Dashboard</h1>
                    <p class="text-muted mb-0">Welcome, {{ user.username }}!</p>
                </div>
                <div class="d-flex gap-2">
                    {% if user.kyc_status == 'approved' %}
                        <span class="badge bg-success fs-6">
                            <i class="fas fa-check-circle me-1"></i>KYC Approved
                        </span>
                    {% elif user.kyc_status == 'pending' %}
                        <span class="badge bg-warning fs-6">
                            <i class="fas fa-clock me-1"></i>KYC Pending
                        </span>
                    {% else %}
                        <span class="badge bg-danger fs-6">
                            <i class="fas fa-times-circle me-1"></i>KYC Required
                        </span>
                    {% endif %}
                    
                    {% if user.onchain_id %}
                        <a href="{{ url_for('onchainid.view_onchainid', onchainid_address=user.onchain_id) }}?tab_session={{ request.args.get('tab_session') }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-eye me-1"></i>OnchainID
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- KYC Status Card (Compact) -->
    {% if user.kyc_status != 'approved' %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-{{ 'warning' if user.kyc_status == 'pending' else 'danger' }}">
                    <div class="card-body py-3">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                {% if user.kyc_status == 'pending' %}
                                    <i class="fas fa-clock text-warning fa-lg"></i>
                                {% else %}
                                    <i class="fas fa-exclamation-triangle text-danger fa-lg"></i>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1">
                                {% if user.kyc_status == 'pending' %}
                                    <h6 class="mb-1">KYC Under Review</h6>
                                    <p class="text-muted mb-0">Your KYC application is being reviewed by a trusted issuer. You'll be notified once approved.</p>
                                {% else %}
                                    <h6 class="mb-1">KYC Required</h6>
                                    <p class="text-muted mb-0">Use the KYC system below to submit your verification request.</p>
                                {% endif %}
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Investment Guide and KYC System in 2-column layout -->
    {% if user.kyc_status == 'approved' %}
        <div class="row mb-4">
            <!-- How to Invest in Tokens -->
            <div class="col-md-6">
                <div class="card border-info h-100">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>How to Invest in Tokens
                        </h6>
                    </div>
                    <div class="card-body">
                        <ol class="text-muted mb-0">
                            <li><strong>Express Interest:</strong> Submit interest in a token (one-time approval required)</li>
                            <li><strong>Request Purchase:</strong> Submit purchase requests for the amount you want to buy</li>
                            <li><strong>Wait for Approval:</strong> Issuer reviews and approves your request</li>
                            <li><strong>Tokens Minted:</strong> Tokens are minted to your wallet after approval</li>
                            <li><strong>Buy More:</strong> You can continue buying more tokens after each purchase is completed!</li>
                        </ol>
                    </div>
                </div>
            </div>
            
            <!-- Multi-Lane KYC System -->
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-network-wired me-2"></i>Multi-Lane KYC System
                        </h6>
                    </div>
                    <div class="card-body">
                        <h6 class="text-primary">How it works:</h6>
                        <ul class="mb-3">
                            <li><strong>Select Trusted Issuer:</strong> Choose from approved trusted issuers based on your needs</li>
                            <li><strong>Choose Claims:</strong> Select specific T-REX standard claims you need (KYC, AML, etc.)</li>
                            <li><strong>Multiple Requests:</strong> Submit requests to different trusted issuers for different claims</li>
                            <li><strong>Track Progress:</strong> Monitor the status of all your KYC requests</li>
                        </ul>
                        <div class="d-grid gap-2">
                            <a href="{{ url_for('kyc_system.select_trusted_issuer', tab_session=tab_session_id) }}" class="btn btn-primary btn-sm">
                                <i class="fas fa-plus me-2"></i>Submit New KYC Request
                            </a>
                                                        <a href="{{ url_for('kyc_system.kyc_requests', tab_session=tab_session_id) }}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-list me-2"></i>View My Requests
                            </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        </div>
    {% endif %}
    
    <!-- KYC System for Non-Approved Users -->
    {% if user.kyc_status != 'approved' %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-warning text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-user-check me-2"></i>KYC Verification Required
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="text-warning">How to get verified:</h6>
                                <ul class="mb-3">
                                    <li><strong>Select Trusted Issuer:</strong> Choose from approved trusted issuers based on your needs</li>
                                    <li><strong>Choose Claims:</strong> Select specific T-REX standard claims you need (KYC, AML, etc.)</li>
                                    <li><strong>Submit Request:</strong> Submit your KYC request to the selected trusted issuer</li>
                                    <li><strong>Wait for Approval:</strong> The trusted issuer will review and process your request</li>
                                </ul>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="d-grid gap-2">
                                    <a href="{{ url_for('kyc_system.select_trusted_issuer', tab_session=tab_session_id) }}" class="btn btn-warning">
                                        <i class="fas fa-plus me-2"></i>Submit KYC Request
                                    </a>
                                    <a href="{{ url_for('kyc_system.kyc_requests', tab_session=tab_session_id) }}" class="btn btn-outline-warning">
                                        <i class="fas fa-list me-2"></i>View My Requests
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- KYC Status Alerts -->
        {% if user.kyc_status == 'not_submitted' %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Get Started:</strong> You can now submit KYC requests to specific trusted issuers for the claims you need.
                    </div>
                </div>
            </div>
        {% elif user.kyc_status == 'pending' %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-warning">
                        <i class="fas fa-clock me-2"></i>
                        <strong>KYC In Progress:</strong> You have pending KYC requests. Check the status in "View My Requests".
                    </div>
                </div>
            </div>
        {% endif %}
    {% endif %}

    <!-- Tabs: Requests | My Tokens -->
    <ul class="nav nav-tabs" id="invTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="requests-tab" data-bs-toggle="tab" data-bs-target="#requests" type="button" role="tab">Requests</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="mytokens-tab" data-bs-toggle="tab" data-bs-target="#mytokens" type="button" role="tab">My Tokens</button>
      </li>
    </ul>
    <div class="tab-content" id="invTabsContent">
      <div class="tab-pane fade show active" id="requests" role="tabpanel">
        <!-- Available Tokens -->
        <div class="row mt-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h4>Available Tokens</h4>
              </div>
              <div class="card-body">
                    {% if available_tokens %}
                        <div class="row">
                            {% for token in available_tokens %}
                            <div class="col-md-6 col-lg-4 mb-4">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <h5 class="card-title">{{ token.name }} ({{ token.symbol }})</h5>
                                        <p class="card-text">{{ token.description[:100] }}{% if token.description|length > 100 %}...{% endif %}</p>
                                        <ul class="list-unstyled">
                                            <li><strong>Total Supply:</strong> {{ "{:,.0f}".format(token.total_supply) }}</li>
                                            <li><strong>Price:</strong> ${{ "%.2f"|format(token.price_per_token) }}</li>
                                            <li><strong>Deployed:</strong> {{ token.deployed_at.strftime('%Y-%m-%d') }}</li>
                                        </ul>
                                        
                                        {% if user.kyc_status == 'approved' %}
                                            {% set existing_purchase = purchase_requests | selectattr('token_id', 'equalto', token.id) | list %}
                                            {% set existing_interest = user_interests | selectattr('token_id', 'equalto', token.id) | list %}
                                            
                                            <!-- Debug info (remove in production) -->
                                            {% if existing_purchase %}
                                                <!-- Debug: Found {{ existing_purchase|length }} purchase request(s) for this token -->
                                            {% endif %}
                                            
                                            {% if existing_purchase %}
                                                {% set purchase = existing_purchase[0] %}
                                                <!-- Debug: Purchase status is {{ purchase.status }} -->
                                                {% if purchase.status == 'approved' %}
                                                    <a href="{{ url_for('investor.request_purchase', token_id=token.id, tab_session=tab_session_id) }}" 
                                                       class="btn btn-success btn-sm">
                                                        <i class="fas fa-shopping-cart"></i> Purchase Approved
                                                    </a>
                                                {% elif purchase.status == 'pending' %}
                                                    <span class="badge bg-warning">
                                                        <i class="fas fa-clock me-1"></i>Purchase Pending
                                                    </span>
                                                {% elif purchase.status == 'rejected' %}
                                                    <span class="badge bg-danger">
                                                        <i class="fas fa-times me-1"></i>Purchase Rejected
                                                    </span>
                                                {% elif purchase.status == 'completed' %}
                                                    <!-- Allow new purchase requests after completion -->
                                                    <a href="{{ url_for('investor.request_purchase', token_id=token.id, tab_session=tab_session_id) }}" 
                                                       class="btn btn-primary btn-sm">
                                                        <i class="fas fa-shopping-cart"></i> Buy More Tokens
                                                    </a>
                                                    <br><small class="text-muted">Previous purchase completed</small>
                                                {% else %}
                                                    <!-- Debug: Unknown status {{ purchase.status }} -->
                                                    <span class="badge bg-secondary">
                                                        <i class="fas fa-question me-1"></i>Status: {{ purchase.status }}
                                                    </span>
                                                {% endif %}
                                            {% elif existing_interest %}
                                                {% set interest = existing_interest[0] %}
                                                {% if interest.status == 'approved' %}
                                                    <a href="{{ url_for('investor.request_purchase', token_id=token.id, tab_session=tab_session_id) }}" 
                                                       class="btn btn-primary btn-sm">
                                                        <i class="fas fa-shopping-cart"></i> Request Purchase
                                                    </a>
                                                {% elif interest.status == 'pending' %}
                                                    <span class="badge bg-warning">
                                                        <i class="fas fa-clock me-1"></i>Interest Pending
                                                    </span>
                                                {% elif interest.status == 'rejected' %}
                                                    <span class="badge bg-danger">
                                                        <i class="fas fa-times me-1"></i>Interest Rejected
                                                    </span>
                                                {% endif %}
                                            {% else %}
                                                <button type="button" class="btn btn-outline-primary btn-sm" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#interestModal{{ token.id }}">
                                                    <i class="fas fa-hand-pointer"></i> Express Interest
                                                </button>
                                            {% endif %}
                                        {% else %}
                                            <button class="btn btn-secondary btn-sm" disabled>
                                                <i class="fas fa-lock"></i> KYC Required
                                            </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No tokens available at the moment.</p>
                    {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- My Token Interests -->
        <div class="row mt-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h4>My Token Interests</h4>
              </div>
              <div class="card-body">
                {% if user_interests %}
                <div class="table-responsive">
                  <table class="table table-striped">
                    <thead>
                      <tr>
                        <th>Token</th><th>Amount Requested</th><th>Status</th><th>Requested</th><th>Processed</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for interest in user_interests %}
                      <tr>
                        <td><strong>{{ interest.token.name }}</strong> ({{ interest.token.symbol }})</td>
                        <td>{{ "{:,.0f}".format(interest.amount_requested) }}</td>
                        <td><span class="badge bg-{{ 'warning' if interest.status == 'pending' else 'success' if interest.status == 'approved' else 'danger' }}">{{ interest.status.title() }}</span></td>
                        <td>{{ interest.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>{% if interest.processed_at %}{{ interest.processed_at.strftime('%Y-%m-%d %H:%M') }}{% else %}<span class="text-muted">-</span>{% endif %}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% else %}
                <p class="text-muted">You haven't expressed interest in any tokens yet.</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- My Purchase Requests -->
        <div class="row mt-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h4>My Purchase Requests</h4>
              </div>
              <div class="card-body">
                {% if purchase_requests %}
                <div class="table-responsive">
                  <table class="table table-striped">
                    <thead>
                      <tr>
                        <th>Token</th><th>Amount</th><th>Total Value</th><th>Status</th><th>Verification</th><th>Created</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for request in purchase_requests %}
                      <tr>
                        <td><strong>{{ request.token.name }}</strong> ({{ request.token.symbol }})</td>
                        <td>{{ "{:,.0f}".format(request.amount_requested) }} {{ request.token.symbol }}</td>
                        <td>${{ "%.2f"|format(request.total_value) }}</td>
                        <td><span class="badge bg-{{ 'warning' if request.status=='pending' else 'info' if request.status=='verified' else 'success' if request.status=='approved' else 'danger' if request.status=='rejected' else 'primary' if request.status=='completed' else 'secondary' }}">{{ request.status.title() }}</span></td>
                        {% set vstatus = purchase_verifications.get(request.id) or request.verification_status %}
                        <td><span class="badge bg-{{ 'secondary' if vstatus=='pending' else 'success' if vstatus=='verified' else 'danger' }}">{{ vstatus.title() }}</span></td>
                        <td>{{ request.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% else %}
                <p class="text-muted">You haven't submitted any purchase requests yet.</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <!-- My Token Holdings -->
        {% if my_holdings %}
        <div class="row mt-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <h4><i class="fas fa-coins"></i> My Token Holdings</h4>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-striped">
                    <thead>
                      <tr>
                        <th>Token</th><th>Balance</th><th>Verification Status</th><th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for holding in my_holdings %}
                      <tr>
                        <td><strong>{{ holding.token.name }}</strong> ({{ holding.token.symbol }})</td>
                        <td>{{ "{:,.0f}".format(holding.balance) }} {{ holding.token.symbol }}</td>
                        <td>
                          {% if holding.verified %}
                            <span class="badge bg-success"><i class="fas fa-check"></i> Verified</span>
                          {% else %}
                            <span class="badge bg-warning"><i class="fas fa-exclamation-triangle"></i> Not Verified</span>
                          {% endif %}
                        </td>
                        <td>
                          <a href="{{ url_for('investor.request_purchase', token_id=holding.token.id, tab_session=tab_session_id) }}" 
                             class="btn btn-primary btn-sm">
                            <i class="fas fa-plus"></i> Buy More
                          </a>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}
      </div>

      <!-- My Tokens tab -->
      <div class="tab-pane fade" id="mytokens" role="tabpanel">
        <div class="row mt-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h4>My Tokens (On-chain)</h4>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshMyTokens()">
                  <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
              </div>
              <div class="card-body">
                {% if my_holdings %}
                <div class="table-responsive">
                  <table class="table table-striped">
                    <thead>
                      <tr>
                        <th>Token</th><th>Balance</th><th>Verified</th><th>Token Address</th><th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for h in my_holdings %}
                      <tr>
                        <td><strong>{{ h.token.name }}</strong> ({{ h.token.symbol }})</td>
                        <td>{{ "{:,.4f}".format(h.balance) }} {{ h.token.symbol }}</td>
                        <td>{% if h.verified %}<span class="badge bg-success">Verified</span>{% else %}<span class="badge bg-warning">Not Verified</span>{% endif %}</td>
                        <td><code>{{ h.token.token_address }}</code></td>
                        <td>
                          <div class="btn-group" role="group">
                            <button class="btn btn-outline-primary btn-sm" 
                                    data-token-id="{{ h.token.id }}"
                                    data-token-name="{{ h.token.name }}"
                                    data-token-symbol="{{ h.token.symbol }}"
                                    data-balance="{{ "{:,.4f}".format(h.balance) }}"
                                    data-token-address="{{ h.token.token_address }}"
                                    onclick="openTransferModalFromData(this)">
                              <i class="fas fa-exchange-alt me-1"></i>Transfer
                            </button>
                            <a href="{{ url_for('investor.request_purchase', token_id=h.token.id, tab_session=tab_session_id) }}" class="btn btn-primary btn-sm">
                              <i class="fas fa-plus me-1"></i>Buy More
                            </a>
                          </div>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% else %}
                <p class="text-muted">No on-chain token holdings found for your wallet.</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Remove duplicated sections below; content now lives in the Requests tab -->
    <!-- My Token Interests (duplicate) -->
    <div class="row mt-4 d-none">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4>My Token Interests</h4>
                </div>
                <div class="card-body">
                    {% if user_interests %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Token</th>
                                        <th>Amount Requested</th>
                                        <th>Status</th>
                                        <th>Requested</th>
                                        <th>Processed</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for interest in user_interests %}
                                    <tr>
                                        <td>
                                            <strong>{{ interest.token.name }}</strong> ({{ interest.token.symbol }})
                                        </td>
                                        <td>{{ "{:,.0f}".format(interest.amount_requested) }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'warning' if interest.status == 'pending' else 'success' if interest.status == 'approved' else 'danger' }}">
                                                {{ interest.status.title() }}
                                            </span>
                                        </td>
                                        <td>{{ interest.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            {% if interest.processed_at %}
                                                {{ interest.processed_at.strftime('%Y-%m-%d %H:%M') }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted">You haven't expressed interest in any tokens yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- My Purchase Requests (duplicate) -->
    <div class="row mt-4 d-none">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4>My Purchase Requests</h4>
                    <a href="{{ url_for('investor.purchase_requests', tab_session=tab_session_id) }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-eye me-2"></i>View All
                    </a>
                </div>
                <div class="card-body">
                    {% if purchase_requests %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Token</th>
                                        <th>Amount</th>
                                        <th>Total Value</th>
                                        <th>Status</th>
                                        <th>Verification</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for request in purchase_requests[:5] %}
                                    <tr>
                                        <td>
                                            <strong>{{ request.token.name }}</strong> ({{ request.token.symbol }})
                                        </td>
                                        <td>{{ "{:,}".format(request.amount_requested) }} {{ request.token.symbol }}</td>
                                        <td>${{ "%.2f"|format(request.total_value) }}</td>
                                        <td>
                                            {% if request.status == 'pending' %}
                                                <span class="badge bg-warning">
                                                    <i class="fas fa-clock me-1"></i>Pending
                                                </span>
                                            {% elif request.status == 'verified' %}
                                                <span class="badge bg-info">
                                                    <i class="fas fa-user-check me-1"></i>Verified
                                                </span>
                                            {% elif request.status == 'approved' %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check me-1"></i>Approved
                                                </span>
                                            {% elif request.status == 'rejected' %}
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-times me-1"></i>Rejected
                                                </span>
                                            {% elif request.status == 'completed' %}
                                                <span class="badge bg-primary">
                                                    <i class="fas fa-check-double me-1"></i>Completed
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                        {% set vstatus = purchase_verifications.get(request.id) or request.verification_status %}
                        <span class="badge bg-{{ 'secondary' if vstatus=='pending' else 'success' if vstatus=='verified' else 'danger' }}">
                            {{ vstatus.title() }}
                        </span>
                                        </td>
                                        <td>{{ request.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                        <td>
                                            {% if request.status == 'approved' %}
                                                <form method="POST" action="{{ url_for('investor.execute_purchase', request_id=request.id, tab_session=tab_session_id) }}" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Execute this purchase?')">
                                                        <i class="fas fa-play me-1"></i>Execute
                                                    </button>
                                                </form>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% if purchase_requests|length > 5 %}
                            <div class="text-center mt-3">
                                <a href="{{ url_for('investor.purchase_requests', tab_session=tab_session_id) }}" class="btn btn-outline-primary">
                                    <i class="fas fa-list me-2"></i>View All {{ purchase_requests|length }} Requests
                                </a>
                            </div>
                        {% endif %}
                    {% else %}
                        <p class="text-muted">You haven't submitted any purchase requests yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Interest Modals -->
{% for token in available_tokens %}
<div class="modal fade" id="interestModal{{ token.id }}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Express Interest in {{ token.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
                            <form method="POST" action="{{ url_for('investor.express_interest', token_id=token.id, tab_session=tab_session_id) }}">
                <div class="modal-body">
                    <p>Express your interest in purchasing {{ token.symbol }} tokens.</p>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Process:</strong>
                        <ol class="mb-0 mt-2">
                            <li>Submit interest request</li>
                            <li>Issuer will verify your KYC status</li>
                            <li>If approved, you can request specific purchases</li>
                        </ol>
                    </div>
                    <p class="text-muted">Available: {{ "{:,.0f}".format(token.total_supply) }} {{ token.symbol }}</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Interest</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Transfer Modal -->
<div class="modal fade" id="transferModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
                        <div class="modal-header">
                <h5 class="modal-title">Transfer Tokens</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="transferForm" onsubmit="executeTransfer(event)">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Token</label>
                        <input type="text" class="form-control" id="transfer_token_name" readonly>
                        <input type="hidden" id="transfer_token_id">
                    </div>
                    <div class="mb-3">
                        <label for="transfer_amount" class="form-label">Amount to Transfer</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="transfer_amount" min="1" step="1" required>
                            <span class="input-group-text" id="transfer_symbol"></span>
                        </div>
                        <small class="text-muted">Available: <span id="transfer_balance"></span></small>
                    </div>
                    <div class="mb-3">
                        <label for="transfer_to_address" class="form-label">To Address</label>
                        <input type="text" class="form-control" id="transfer_to_address" placeholder="0x..." required>
                        <small class="text-muted">Enter the recipient's wallet address</small>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="checkRecipientVerification()">
                            <i class="fas fa-check-circle me-1"></i>Check Recipient Verification
                        </button>
                        <small class="text-muted d-block mt-1">Verify the recipient can receive tokens</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-exchange-alt me-1"></i>Transfer Tokens
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Key Management Section -->
{% if user.onchain_id %}
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h4><i class="fas fa-key me-2"></i>OnchainID Key Management</h4>
        <button class="btn btn-primary btn-sm" onclick="openAddKeyModal()">
          <i class="fas fa-plus me-1"></i>Add Key
        </button>
      </div>
      <div class="card-body">
        <p class="text-muted">Manage keys for your OnchainID. Keys control different permissions on your identity.</p>
        <div class="row">
          <div class="col-md-4">
            <div class="card border-primary">
              <div class="card-body text-center">
                <i class="fas fa-cog fa-2x text-primary mb-2"></i>
                <h6>Management Key</h6>
                <small class="text-muted">Purpose 1 - Can add/remove other keys</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-success">
              <div class="card-body text-center">
                <i class="fas fa-bolt fa-2x text-success mb-2"></i>
                <h6>Action Key</h6>
                <small class="text-muted">Purpose 2 - Can execute actions</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-warning">
              <div class="card-body text-center">
                <i class="fas fa-signature fa-2x text-warning mb-2"></i>
                <h6>Claim Signer Key</h6>
                <small class="text-muted">Purpose 3 - Can sign claims</small>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-3">
          <a href="{{ url_for('onchainid.view_onchainid', onchainid_address=user.onchain_id) }}?tab_session={{ request.args.get('tab_session') }}" 
             class="btn btn-outline-primary">
            <i class="fas fa-eye me-1"></i>View All Keys
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Add Key Modal -->
<div id="addKeyModal" class="modal" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Key to OnchainID</h5>
        <button type="button" class="btn-close" onclick="closeAddKeyModal()"></button>
      </div>
      <form id="addKeyForm" onsubmit="executeAddKey(event)">
        <div class="modal-body">
          <div class="mb-3">
            <label for="wallet_address" class="form-label">Wallet Address</label>
            <input type="text" class="form-control" id="wallet_address" name="wallet_address" 
                   placeholder="0x..." required>
          </div>
          <div class="mb-3">
            <label for="purpose" class="form-label">Key Purpose</label>
            <select class="form-select" id="purpose" name="purpose" required>
              <option value="1">Management Key (Purpose 1)</option>
              <option value="2">Action Key (Purpose 2)</option>
              <option value="3">Claim Signer Key (Purpose 3)</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="key_type" class="form-label">Key Type</label>
            <select class="form-select" id="key_type" name="key_type" required>
              <option value="1">ECDSA (Type 1)</option>
              <option value="2">ERC725 (Type 2)</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeAddKeyModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Key</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Remove Key Modal -->
<div id="removeKeyModal" class="modal" style="display: none;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Remove Key from OnchainID</h5>
        <button type="button" class="btn-close" onclick="closeRemoveKeyModal()"></button>
      </div>
      <form id="removeKeyForm" onsubmit="executeRemoveKey(event)">
        <div class="modal-body">
          <div class="mb-3">
            <label for="removeKeyWalletAddress" class="form-label">Wallet Address to Remove</label>
            <input type="text" class="form-control" id="removeKeyWalletAddress" name="wallet_address" 
                   placeholder="0x..." required readonly>
          </div>
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> This action cannot be undone. Make sure you want to remove this key.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeRemoveKeyModal()">Cancel</button>
          <button type="submit" class="btn btn-danger">Remove Key</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Auto-refresh My Tokens tab when activated
document.addEventListener('DOMContentLoaded', function() {
    const myTokensTab = document.getElementById('mytokens-tab');
    const myTokensPane = document.getElementById('mytokens');
    
    // Check if we should activate the My Tokens tab on page load
    const urlParams = new URLSearchParams(window.location.search);
    const activeTab = urlParams.get('active_tab');
    if (activeTab === 'mytokens') {
        // Activate the My Tokens tab
        const tab = new bootstrap.Tab(myTokensTab);
        tab.show();
    }
    
    // Refresh when tab is shown (but only if not coming from a refresh)
    myTokensTab.addEventListener('shown.bs.tab', function() {
        // Only auto-refresh if we're not already on the mytokens tab from a refresh
        if (!urlParams.get('active_tab')) {
            // Add a small delay to ensure the tab is fully visible
            setTimeout(function() {
                refreshMyTokens();
            }, 100);
        }
    });
});

function refreshMyTokens() {
    // Reload the page to get fresh blockchain data, preserving the active tab
    const currentUrl = new URL(window.location);
    currentUrl.searchParams.set('active_tab', 'mytokens');
    window.location.href = currentUrl.toString();
}

function openTransferModalFromData(button) {
    // Get data from button attributes
    const tokenId = button.dataset.tokenId;
    const tokenName = button.dataset.tokenName;
    const tokenSymbol = button.dataset.tokenSymbol;
    const balance = button.dataset.balance;
    const tokenAddress = button.dataset.tokenAddress;
    
    // Populate the transfer modal with token information
    document.getElementById('transfer_token_id').value = tokenId;
    document.getElementById('transfer_token_name').value = `${tokenName} (${tokenSymbol})`;
    document.getElementById('transfer_symbol').textContent = tokenSymbol;
    document.getElementById('transfer_available').textContent = `${balance} ${tokenSymbol}`;
    
    // Set max amount for the transfer
    const amountInput = document.getElementById('transfer_amount');
    amountInput.max = parseFloat(balance);
    amountInput.placeholder = `Max: ${balance}`;
    
    // Clear previous values
    document.getElementById('transfer_to_address').value = '';
    
    // Show the modal
    new bootstrap.Modal(document.getElementById('transferModal')).show();
}

function openTransferModal(tokenId, tokenName, tokenSymbol, balance, tokenAddress) {
    // Populate the transfer modal with token information
    document.getElementById('transfer_token_id').value = tokenId;
    document.getElementById('transfer_token_name').value = `${tokenName} (${tokenSymbol})`;
    document.getElementById('transfer_symbol').textContent = tokenSymbol;
    document.getElementById('transfer_available').textContent = `${balance} ${tokenSymbol}`;
    
    // Set max amount for the transfer
    const amountInput = document.getElementById('transfer_amount');
    amountInput.max = parseFloat(balance);
    amountInput.placeholder = `Max: ${balance}`;
    
    // Clear previous values
    document.getElementById('transfer_to_address').value = '';
    
    // Show the modal
    new bootstrap.Modal(document.getElementById('transferModal')).show();
}





function confirmTransfer() {
    console.log('confirmTransfer function called');
    
    const form = document.getElementById('transferForm');
    console.log('Form element found:', form);
    
    if (!form) {
        console.error('Form not found!');
        alert('Form not found. Please refresh the page.');
        return;
    }
    
    const tokenId = document.getElementById('transfer_token_id').value;
    const amount = document.getElementById('transfer_amount').value;
    const toAddress = document.getElementById('transfer_to_address').value;
    
    if (!tokenId || !amount || !toAddress) {
        alert('Please fill in all required fields');
        return;
    }
    
    if (parseFloat(amount) <= 0) {
        alert('Amount must be greater than 0');
        return;
    }
    
    if (!toAddress.startsWith('0x') || toAddress.length !== 42) {
        alert('Please enter a valid Ethereum address (0x followed by 40 characters)');
        return;
    }
    
    if (confirm(`Transfer ${amount} tokens to ${toAddress}?`)) {
        console.log('Transfer confirmed, building transaction for MetaMask...');
        
        // Build transfer transaction
        const requestData = {
            token_id: tokenId,
            amount: amount,
            to_address: toAddress
        };
        
        console.log('Sending transfer data:', requestData);
        
        fetch('{{ url_for("investor.build_transfer_transaction") }}?tab_session={{ tab_session_id }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            console.log('Transfer transaction response:', data);
            if (data.success) {
                console.log('Transaction built successfully, sending to MetaMask...');
                
                // Send transaction to MetaMask
                window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [data.transaction]
                })
                .then(txHash => {
                    console.log('MetaMask transaction hash:', txHash);
                    
                    // Execute transfer on backend
                    const executeData = {
                        token_id: tokenId,
                        amount: amount,
                        to_address: toAddress,
                        tx_hash: txHash
                    };
                    
                    return fetch('{{ url_for("investor.execute_transfer") }}?tab_session={{ tab_session_id }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(executeData)
                    });
                })
                .then(response => response.json())
                .then(result => {
                    console.log('Transfer execution result:', result);
                    if (result.success) {
                        alert(result.message);
                window.location.reload();
            } else {
                        alert('Transfer execution failed: ' + result.error);
                    }
                })
                .catch(error => {
                    console.error('MetaMask or execution error:', error);
                    alert('Transfer failed: ' + error.message);
                });
            } else {
                alert('Failed to build transfer transaction: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Transfer fetch error:', error);
            alert('Transfer failed: ' + error.message);
        });
    }
}

function checkRecipientVerification() {
    console.log('checkRecipientVerification called');
    
    const toAddress = document.getElementById('transfer_to_address').value;
    const tokenId = document.getElementById('transfer_token_id').value;
    
    console.log('toAddress:', toAddress);
    console.log('tokenId:', tokenId);
    
    if (!toAddress || !toAddress.startsWith('0x')) {
        alert('Please enter a valid Ethereum address first');
        return;
    }
    
    if (!tokenId) {
        alert('Please select a token first');
        return;
    }
    
    // Show loading state
    const checkButton = event.target;
    const originalText = checkButton.innerHTML;
    checkButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Checking...';
    checkButton.disabled = true;
    
    const requestData = {
        address: toAddress,
        token_id: tokenId
    };
    
    console.log('Sending request data:', requestData);
    const requestUrl = '{{ url_for("investor.check_verification") }}?tab_session={{ tab_session_id }}';
    console.log('Request URL:', requestUrl);
    
    // Call the verification API with token context
    fetch(requestUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        console.log('Response received:', response);
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.verified) {
            alert(`✅ Address ${toAddress} is verified for this token and can receive tokens`);
        } else {
            alert(`❌ Address ${toAddress} is not verified for this token: ${data.reason || 'Unknown reason'}`);
        }
    })
    .catch(error => {
        console.error('Verification check failed:', error);
        alert('Failed to check verification status');
    })
    .finally(() => {
        // Restore button state
        checkButton.innerHTML = originalText;
        checkButton.disabled = false;
    });
}

function openTransferModalFromData(button) {
    console.log('openTransferModalFromData called with button:', button);
    
    const tokenId = button.getAttribute('data-token-id');
    const tokenName = button.getAttribute('data-token-name');
    const tokenSymbol = button.getAttribute('data-token-symbol');
    const balance = button.getAttribute('data-balance');
    const tokenAddress = button.getAttribute('data-token-address');
    
    console.log('Transfer data:', { tokenId, tokenName, tokenSymbol, balance, tokenAddress });
    
    // Set the form values
    document.getElementById('transfer_token_id').value = tokenId;
    document.getElementById('transfer_token_name').value = `${tokenName} (${tokenSymbol})`;
    document.getElementById('transfer_balance').textContent = `${balance} ${tokenSymbol}`;
    document.getElementById('transfer_symbol').textContent = tokenSymbol;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('transferModal'));
    modal.show();
}

function executeTransfer(event) {
    console.log('executeTransfer called');
    event.preventDefault(); // Prevent form submission
    
    const form = document.getElementById('transferForm');
    console.log('Form element found:', form);
    
    if (!form) {
        console.error('Form not found!');
        alert('Form not found. Please refresh the page.');
        return;
    }
    
    const tokenId = document.getElementById('transfer_token_id').value;
    const amount = document.getElementById('transfer_amount').value;
    const toAddress = document.getElementById('transfer_to_address').value;
    
    console.log('Transfer data:', { tokenId, amount, toAddress });
    
    if (!tokenId || !amount || !toAddress) {
        alert('Please fill in all required fields');
        return;
    }
    
    if (parseFloat(amount) <= 0) {
        alert('Amount must be greater than 0');
        return;
    }
    
    if (!toAddress.startsWith('0x') || toAddress.length !== 42) {
        alert('Please enter a valid Ethereum address (0x followed by 40 characters)');
        return;
    }
    
    if (confirm(`Transfer ${amount} tokens to ${toAddress}?`)) {
        console.log('Transfer confirmed, building transaction for MetaMask...');
        
        // Build transfer transaction
        const requestData = {
            token_id: tokenId,
            amount: amount,
            to_address: toAddress
        };
        
        console.log('Sending transfer data:', requestData);
        
        fetch('{{ url_for("investor.build_transfer_transaction") }}?tab_session={{ tab_session_id }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            console.log('Transfer transaction response:', data);
            if (data.success) {
                console.log('Transaction built successfully, sending to MetaMask...');
                
                // Send transaction to MetaMask
                window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [data.transaction]
                })
                .then(txHash => {
                    console.log('MetaMask transaction hash:', txHash);
                    
                    // Execute transfer on backend
                    const executeData = {
                        token_id: tokenId,
                        amount: amount,
                        to_address: toAddress,
                        tx_hash: txHash
                    };
                    
                    return fetch('{{ url_for("investor.execute_transfer") }}?tab_session={{ tab_session_id }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(executeData)
                    });
                })
                .then(response => response.json())
                .then(result => {
                    console.log('Transfer execution result:', result);
                    if (result.success) {
                        alert(result.message);
                        window.location.reload();
                    } else {
                        alert('Transfer execution failed: ' + result.error);
                    }
                })
                .catch(error => {
                    console.error('MetaMask or execution error:', error);
                    alert('Transfer failed: ' + error.message);
                });
            } else {
                alert('Failed to build transfer transaction: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Transfer fetch error:', error);
            alert('Transfer failed: ' + error.message);
        });
    }
}

// Key Management Functions
function openAddKeyModal() {
    document.getElementById('addKeyModal').style.display = 'block';
}

function closeAddKeyModal() {
    document.getElementById('addKeyModal').style.display = 'none';
    document.getElementById('addKeyForm').reset();
}

function openRemoveKeyModal(walletAddress) {
    document.getElementById('removeKeyWalletAddress').value = walletAddress;
    document.getElementById('removeKeyModal').style.display = 'block';
}

function closeRemoveKeyModal() {
    document.getElementById('removeKeyModal').style.display = 'none';
    document.getElementById('removeKeyForm').reset();
}

async function executeAddKey(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const walletAddress = formData.get('wallet_address');
    const purpose = parseInt(formData.get('purpose'));
    const keyType = parseInt(formData.get('key_type'));
    
    if (!walletAddress) {
        alert('Please enter a wallet address');
        return;
    }
    
    try {
        // Get connected account
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const userAddress = accounts[0];
        
        // Build transaction
        const response = await fetch('/onchainid/build-add-key-transaction', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                onchainid_address: '{{ user.onchain_id }}',
                wallet_address: walletAddress,
                purpose: purpose,
                key_type: keyType
            })
        });
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error);
        }
        
        // Send to MetaMask
        const txHash = await window.ethereum.request({
            method: 'eth_sendTransaction',
            params: [result.transaction]
        });
        
        // Wait for transaction
        const receipt = await waitForTransaction(txHash);
        
        if (receipt.status === '0x1') {
            // Update database
            await fetch('/onchainid/execute-add-key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    onchainid_address: '{{ user.onchain_id }}',
                    wallet_address: walletAddress,
                    purpose: purpose,
                    key_type: keyType,
                    transaction_hash: txHash
                })
            });
            
            alert('Key added successfully!');
            closeAddKeyModal();
            location.reload();
        } else {
            throw new Error('Transaction failed');
        }
        
    } catch (error) {
        console.error('Add key error:', error);
        alert('Add key failed: ' + error.message);
    }
}

async function executeRemoveKey(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const walletAddress = formData.get('wallet_address');
    
    if (!walletAddress) {
        alert('Please enter a wallet address');
        return;
    }
    
    try {
        // Get connected account
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const userAddress = accounts[0];
        
        // Build transaction
        const response = await fetch('/onchainid/build-remove-key-transaction', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                onchainid_address: '{{ user.onchain_id }}',
                wallet_address: walletAddress,
                user_address: userAddress
            })
        });
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error);
        }
        
        // Send to MetaMask
        const txHash = await window.ethereum.request({
            method: 'eth_sendTransaction',
            params: [result.transaction]
        });
        
        // Wait for transaction
        const receipt = await waitForTransaction(txHash);
        
        if (receipt.status === '0x1') {
            // Update database
            await fetch('/onchainid/execute-remove-key', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    onchainid_address: '{{ user.onchain_id }}',
                    wallet_address: walletAddress,
                    transaction_hash: txHash
                })
            });
            
            alert('Key removed successfully!');
            closeRemoveKeyModal();
            location.reload();
        } else {
            throw new Error('Transaction failed');
        }
        
    } catch (error) {
        console.error('Remove key error:', error);
        alert('Remove key failed: ' + error.message);
    }
}

async function waitForTransaction(txHash) {
    return new Promise((resolve, reject) => {
        const checkTransaction = async () => {
            try {
                const receipt = await window.ethereum.request({
                    method: 'eth_getTransactionReceipt',
                    params: [txHash]
                });
                
                if (receipt) {
                    resolve(receipt);
                } else {
                    setTimeout(checkTransaction, 2000);
                }
            } catch (error) {
                reject(error);
            }
        };
        checkTransaction();
    });
}

</script>
{% endblock %}